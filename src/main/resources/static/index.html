<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Tutor â€” Programming Mentor</title>

    <!-- Marked (Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Prism for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg-primary: #0D0D0D;
            --bg-secondary: #171717;
            --bg-tertiary: #202020;
            --text-primary: #ECECEC;
            --text-secondary: #8E8E93;
            --border-color: rgba(255,255,255,0.06);
            --accent: #10A37F;
            --accent-hover: #0E8B6E;
            --danger: #EF4444;
            --user-msg: #2B2B2B;
            --bot-msg: var(--bg-secondary);
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-chat-btn {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .new-chat-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        .sidebar-controls {
            padding: 8px 12px;
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        .chat-list {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chat-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            gap: 10px;
            position: relative;
            group: hover;
        }

        .chat-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .chat-item.active {
            background: rgba(255,255,255,0.08);
        }

        .chat-item-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chat-item-actions {
            display: none;
            gap: 4px;
            position: absolute;
            right: 8px;
            background: var(--bg-secondary);
            padding: 2px;
            border-radius: 6px;
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
        }

        .chat-action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }

        .chat-action-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 10px;
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.2s;
        }

        .user-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .footer-actions {
            display: flex;
            gap: 6px;
        }

        .footer-btn {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .footer-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        /* ========== MAIN AREA ========== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .main-header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .messages-wrapper {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .message-group {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .message-avatar.user {
            background: var(--accent);
            color: white;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-text {
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        .message-text ul, .message-text ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-text li {
            margin-bottom: 6px;
        }

        .message-text code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            color: #E06C75;
        }

        .message-text pre {
            margin: 16px 0;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
            color: var(--text-primary);
            display: block;
            overflow-x: auto;
        }

        .code-block-wrapper {
            margin: 16px 0;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-color);
        }

        .code-language {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
        }

        .copy-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .copy-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            color: var(--accent);
            border-color: var(--accent);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 500px;
            line-height: 1.5;
        }

        /* ========== INPUT AREA ========== */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16,163,127,0.1);
        }

        .input-field {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            resize: none;
            font-family: inherit;
        }

        .input-field::-webkit-scrollbar {
            width: 6px;
        }

        .input-field::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .send-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        /* ========== LOADING ANIMATION ========== */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: loadingDot 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ========== TOAST ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.3s ease-out;
            min-width: 250px;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .header-stats {
                display: none;
            }

            .messages-wrapper {
                padding: 16px 12px;
            }

            .input-area {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
<div class="app" id="app">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="btnNew">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                New Chat
            </button>
        </div>

        <div class="sidebar-controls">
            <button class="icon-btn" id="btnListRefresh" title="Refresh">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
            </button>
            <input type="text" id="searchInput" placeholder="Search..." class="user-input" style="flex:1; margin:0;" />
        </div>

        <div class="chat-list" id="chatList" role="list"></div>

        <div class="sidebar-footer">
            <input type="text" id="userId" placeholder="User ID" class="user-input" />
            <div class="footer-actions">
                <button class="footer-btn" id="btnExport">Export</button>
                <button class="footer-btn" id="btnClearAll">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Main Area -->
    <div class="main">
        <div class="main-header">
            <div class="header-title" id="mainTitle">AI Tutor</div>
            <div class="header-stats">
                <div id="statTurns">0 turns</div>
                <div id="statMsgs">0 messages</div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="messages-wrapper" id="messages"></div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <div class="input-container">
                    <div class="input-field" contenteditable="true" id="composer" data-placeholder="Ask me anything about programming..."></div>
                    <div class="input-actions">
                        <button class="clear-btn" id="btnClear">Clear</button>
                        <button class="send-btn" id="sendBtn">
                            Send
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastRoot"></div>

<script>
    /* ========== CONFIG ========== */
    const API_BASE = 'http://localhost:8080/api/tutor';
    const DEFAULT_USER = 'user123';
    const DEFAULT_NAME = 'Student';

    /* ========== STATE ========== */
    let state = {
        userId: localStorage.getItem('tutor_userId') || DEFAULT_USER,
        userName: localStorage.getItem('tutor_userName') || DEFAULT_NAME,
        conversations: JSON.parse(localStorage.getItem('tutor_conversations') || '[]'),
        activeConversationId: localStorage.getItem('tutor_activeConversationId') || null,
        messages: JSON.parse(localStorage.getItem('tutor_messages') || '{}'),
        loading: false,
    };

    /* ========== HELPERS ========== */
    function saveState() {
        localStorage.setItem('tutor_userId', state.userId);
        localStorage.setItem('tutor_userName', state.userName);
        localStorage.setItem('tutor_conversations', JSON.stringify(state.conversations));
        localStorage.setItem('tutor_activeConversationId', state.activeConversationId);
        localStorage.setItem('tutor_messages', JSON.stringify(state.messages));
    }

    function toast(msg, opts = {}) {
        const root = document.getElementById('toastRoot');
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = msg;
        root.appendChild(el);
        setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateX(100%)';
            setTimeout(() => el.remove(), 300);
        }, opts.duration || 3000);
    }

    function timeAgo(ts) {
        const d = Date.now() - ts;
        if (d < 60000) return 'just now';
        if (d < 3600000) return Math.floor(d/60000) + 'm ago';
        if (d < 86400000) return Math.floor(d/3600000) + 'h ago';
        return Math.floor(d/86400000) + 'd ago';
    }

    function renderMarkdown(md) {
        try {
            return marked.parse(md || '');
        } catch(e) {
            return '<pre>' + escapeHtml(md) + '</pre>';
        }
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function generateConversationObj(title) {
        const id = 'convo-' + cryptoRandomId();
        return { conversationId: id, title: title || 'New Chat', createdAt: Date.now(), pinned:false };
    }

    function cryptoRandomId() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    /* ========== DOM REFS ========== */
    const chatListEl = document.getElementById('chatList');
    const btnNew = document.getElementById('btnNew');
    const btnListRefresh = document.getElementById('btnListRefresh');
    const searchInput = document.getElementById('searchInput');
    const userIdInput = document.getElementById('userId');
    const mainTitle = document.getElementById('mainTitle');
    const messagesContainer = document.getElementById('messagesContainer');
    const messagesEl = document.getElementById('messages');
    const composer = document.getElementById('composer');
    const sendBtn = document.getElementById('sendBtn');
    const btnClear = document.getElementById('btnClear');
    const statTurns = document.getElementById('statTurns');
    const statMsgs = document.getElementById('statMsgs');
    const btnExport = document.getElementById('btnExport');
    const btnClearAll = document.getElementById('btnClearAll');

    /* ========== INIT UI ========== */
    function initUI() {
        userIdInput.value = state.userId;

        btnNew.addEventListener('click', onNewChatClicked);
        btnListRefresh.addEventListener('click', loadConversationsFromServer);
        searchInput.addEventListener('input', renderChatList);
        userIdInput.addEventListener('change', (e) => {
            state.userId = e.target.value.trim() || DEFAULT_USER;
            saveState();
        });

        sendBtn.addEventListener('click', onSendClicked);
        btnClear.addEventListener('click', () => {
            composer.innerHTML = '';
            composer.focus();
        });

        btnExport.addEventListener('click', exportAll);
        btnClearAll.addEventListener('click', clearAllConfirmed);

        composer.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

        // Handle empty placeholder
        composer.addEventListener('focus', function() {
            if (!this.textContent.trim()) {
                this.innerHTML = '';
            }
        });

        renderChatList();
        if (state.activeConversationId) {
            activateConversation(state.activeConversationId, {skipServerSwitch:true});
        } else if (state.conversations.length > 0) {
            activateConversation(state.conversations[0].conversationId, {skipServerSwitch:true});
        } else {
            showWelcome();
        }
    }

    /* ========== CHAT LIST ========== */
    function renderChatList() {
        const q = (searchInput.value || '').toLowerCase();
        chatListEl.innerHTML = '';
        const items = state.conversations.slice().sort((a,b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return b.createdAt - a.createdAt;
        });

        items.forEach(c => {
            if (q && !c.title.toLowerCase().includes(q)) return;

            const el = document.createElement('div');
            el.className = 'chat-item' + (c.conversationId === state.activeConversationId ? ' active' : '');

            const icon = document.createElement('div');
            icon.className = 'chat-item-icon';
            icon.textContent = c.pinned ? 'ðŸ“Œ' : 'ðŸ’¬';

            const content = document.createElement('div');
            content.className = 'chat-item-content';

            const title = document.createElement('div');
            title.className = 'chat-item-title';
            title.textContent = c.title;

            const meta = document.createElement('div');
            meta.className = 'chat-item-meta';
            const msgs = (state.messages[c.conversationId] || []).length;
            meta.textContent = `${msgs} msgs â€¢ ${timeAgo(c.createdAt)}`;

            content.appendChild(title);
            content.appendChild(meta);

            const actions = document.createElement('div');
            actions.className = 'chat-item-actions';

            const btnPin = document.createElement('button');
            btnPin.className = 'chat-action-btn';
            btnPin.textContent = c.pinned ? 'â˜…' : 'â˜†';
            btnPin.title = c.pinned ? 'Unpin' : 'Pin';
            btnPin.addEventListener('click', (ev) => {
                ev.stopPropagation();
                c.pinned = !c.pinned;
                saveState();
                renderChatList();
            });

            const btnRename = document.createElement('button');
            btnRename.className = 'chat-action-btn';
            btnRename.textContent = 'âœŽ';
            btnRename.title = 'Rename';
            btnRename.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const newTitle = prompt('Enter new title', c.title);
                if (newTitle) {
                    c.title = newTitle;
                    saveState();
                    renderChatList();
                    if (c.conversationId === state.activeConversationId) {
                        mainTitle.textContent = c.title;
                    }
                }
            });

            const btnDelete = document.createElement('button');
            btnDelete.className = 'chat-action-btn';
            btnDelete.textContent = 'ðŸ—‘';
            btnDelete.title = 'Delete';
            btnDelete.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                if (!confirm('Delete this conversation?')) return;
                await deleteConversation(c.conversationId);
            });

            actions.appendChild(btnPin);
            actions.appendChild(btnRename);
            actions.appendChild(btnDelete);

            el.appendChild(icon);
            el.appendChild(content);
            el.appendChild(actions);

            el.addEventListener('click', () => {
                activateConversation(c.conversationId);
            });

            chatListEl.appendChild(el);
        });
    }

    /* ========== CONVERSATION MANAGEMENT ========== */
    async function onNewChatClicked() {
        const title = prompt('Enter chat title', 'New Chat');
        if (!title) return;

        try {
            const userId = (document.getElementById('userId').value || DEFAULT_USER).trim();
            state.userId = userId;
            saveState();

            const res = await fetch(`${API_BASE}/start/${encodeURIComponent(state.userId)}?title=${encodeURIComponent(title)}`, { method: 'POST' });
            if (!res.ok) throw new Error('Failed to create conversation on server');
            const serverConvo = await res.json();

            const convoObj = {
                conversationId: serverConvo.conversationId || serverConvo.id || generateConversationObj(title).conversationId,
                title: serverConvo.title || title,
                createdAt: serverConvo.createdAt ? +new Date(serverConvo.createdAt) : Date.now(),
                pinned: false
            };

            state.conversations.push(convoObj);
            state.messages[convoObj.conversationId] = [];
            state.activeConversationId = convoObj.conversationId;
            saveState();
            renderChatList();
            activateConversation(convoObj.conversationId, { skipServerSwitch:true });
        } catch (err) {
            console.error(err);
            toast('Failed to create conversation');
        }
    }

    async function activateConversation(conversationId, opts = {}) {
        const convo = state.conversations.find(c => c.conversationId === conversationId);
        if (!convo) {
            toast('Conversation not found');
            return;
        }

        state.activeConversationId = convo.conversationId;
        saveState();
        renderChatList();

        if (!opts.skipServerSwitch) {
            try {
                const res = await fetch(`${API_BASE}/switch/${encodeURIComponent(state.userId)}/${encodeURIComponent(convo.conversationId)}`, { method: 'POST' });
                if (!res.ok) console.warn('Server switch failed', res.status);
            } catch(e) {
                console.warn('Server switch error', e);
            }
        }

        mainTitle.textContent = convo.title;
        renderMessagesFor(convo.conversationId);
        updateStatsFor(convo.conversationId);
    }

    async function deleteConversation(conversationId) {
        const idx = state.conversations.findIndex(c => c.conversationId === conversationId);
        if (idx === -1) {
            toast('Conversation not found');
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/clear/${encodeURIComponent(state.userId)}/${encodeURIComponent(conversationId)}`, { method: 'DELETE' });
            if (!res.ok) console.warn('Server delete returned', res.status);
        } catch (e) {
            console.warn('server delete failed', e);
        }

        state.conversations.splice(idx,1);
        delete state.messages[conversationId];
        if (state.activeConversationId === conversationId) {
            state.activeConversationId = state.conversations.length ? state.conversations[0].conversationId : null;
        }
        saveState();
        renderChatList();
        if (state.activeConversationId) activateConversation(state.activeConversationId, { skipServerSwitch:true });
        else showWelcome();
    }

    async function clearAllConfirmed() {
        if (!confirm('Delete ALL conversations?')) return;

        try {
            const res = await fetch(`${API_BASE}/clearAll/${encodeURIComponent(state.userId)}`, { method: 'DELETE' });
            if (!res.ok) console.warn('server clearAll status', res.status);
        } catch (e) {
            console.warn('server clearAll failed', e);
        }

        state.conversations = [];
        state.messages = {};
        state.activeConversationId = null;
        saveState();
        renderChatList();
        showWelcome();
        toast('All conversations cleared');
    }

    function exportAll() {
        const payload = {
            exportedAt: new Date().toISOString(),
            userId: state.userId,
            conversations: state.conversations,
            messages: state.messages
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai-tutor-${state.userId}-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    async function loadConversationsFromServer() {
        const uid = (document.getElementById('userId').value || DEFAULT_USER).trim();
        state.userId = uid;
        saveState();

        try {
            const res = await fetch(`${API_BASE}/list/${encodeURIComponent(state.userId)}`);
            if (!res.ok) throw new Error('Server returned ' + res.status);
            const serverList = await res.json();

            serverList.forEach(s => {
                if (!state.conversations.find(c => c.conversationId === s.conversationId)) {
                    state.conversations.push({
                        conversationId: s.conversationId,
                        title: s.title || 'Chat',
                        createdAt: s.createdAt ? +new Date(s.createdAt) : Date.now(),
                        pinned:false
                    });
                    state.messages[s.conversationId] = state.messages[s.conversationId] || [];
                }
            });
            saveState();
            renderChatList();
            toast('Synced with server');
        } catch (err) {
            console.warn('loadConversationsFromServer failed', err);
            toast('Could not load from server');
        }
    }

    /* ========== MESSAGE RENDERING ========== */
    function renderMessagesFor(conversationId) {
        const arr = state.messages[conversationId] || [];
        messagesEl.innerHTML = '';

        if (!arr.length) {
            showEmptyState();
            return;
        }

        arr.forEach(m => {
            const group = document.createElement('div');
            group.className = 'message-group';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar' + (m.role === 'user' ? ' user' : '');
            avatar.textContent = m.role === 'user' ? 'Y' : 'AI';

            const content = document.createElement('div');
            content.className = 'message-content';

            const text = document.createElement('div');
            text.className = 'message-text';

            if (m.role === 'bot') {
                text.innerHTML = renderMarkdown(m.text);
                setTimeout(() => {
                    enhanceCodeBlocks(text);
                    Prism.highlightAllUnder(text);
                }, 0);
            } else {
                text.textContent = m.text;
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = timeAgo(m.ts);

            content.appendChild(text);
            content.appendChild(time);

            group.appendChild(avatar);
            group.appendChild(content);
            messagesEl.appendChild(group);
        });

        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 50);
    }

    function enhanceCodeBlocks(container) {
        const blocks = container.querySelectorAll('pre code');
        blocks.forEach(block => {
            const pre = block.parentElement;
            if (!pre || pre.dataset.enhanced) return;
            pre.dataset.enhanced = '1';

            const classMatch = block.className.match(/language-(\w+)/);
            const lang = classMatch ? classMatch[1] : 'code';

            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';

            const header = document.createElement('div');
            header.className = 'code-header';

            const langLabel = document.createElement('div');
            langLabel.className = 'code-language';
            langLabel.textContent = lang;

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(block.textContent).then(() => {
                    copyBtn.textContent = 'Copied!';
                    copyBtn.classList.add('copied');
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                });
            });

            header.appendChild(langLabel);
            header.appendChild(copyBtn);

            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(header);
            wrapper.appendChild(pre);
        });
    }

    function showEmptyState() {
        messagesEl.innerHTML = `
            <div style="text-align:center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.6;">ðŸ’¬</div>
                <div style="font-size: 16px; margin-bottom: 8px; color: var(--text-primary);">Start the conversation</div>
                <div style="font-size: 14px;">Ask anything about programming, algorithms, or software development</div>
            </div>
        `;
    }

    function pushMessage(conversationId, role, text) {
        if (!state.messages[conversationId]) state.messages[conversationId] = [];
        state.messages[conversationId].push({ role, text, ts: Date.now() });
        saveState();
    }

    function updateStatsFor(conversationId) {
        const turns = state.messages[conversationId] ? state.messages[conversationId].filter(m => m.role === 'user').length : 0;
        const msgs = state.messages[conversationId] ? state.messages[conversationId].length : 0;
        statTurns.textContent = `${turns} turn${turns !== 1 ? 's' : ''}`;
        statMsgs.textContent = `${msgs} message${msgs !== 1 ? 's' : ''}`;
    }

    /* ========== SENDING ========== */
    async function onSendClicked() {
        const text = (composer.innerText || '').trim();
        if (!text) {
            toast('Please type a message');
            return;
        }
        if (!state.activeConversationId) {
            toast('Select or create a conversation first');
            return;
        }

        const userIdVal = (document.getElementById('userId').value || '').trim();
        if (!userIdVal) {
            toast('Please enter User ID');
            return;
        }
        state.userId = userIdVal;
        saveState();

        pushMessage(state.activeConversationId, 'user', text);
        renderMessagesFor(state.activeConversationId);
        updateStatsFor(state.activeConversationId);

        composer.innerHTML = '';
        const loadingToken = showLoadingBubble(state.activeConversationId);

        try {
            const res = await fetch(`${API_BASE}/ask/${encodeURIComponent(state.userId)}/${encodeURIComponent(state.activeConversationId)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: text,
                    userId: state.userId,
                    userName: state.userName,
                    conversationId: state.activeConversationId
                })
            });

            if (!res.ok) {
                const body = await res.text();
                throw new Error(`Server error: ${res.status} - ${body}`);
            }

            const data = await res.json();
            removeLoadingBubble(loadingToken);
            const answerText = data.answer || data.content || 'No response';
            pushMessage(state.activeConversationId, 'bot', answerText);
            renderMessagesFor(state.activeConversationId);
            updateStatsFor(state.activeConversationId);

            if (data.conversationId && data.conversationId !== state.activeConversationId) {
                const local = state.conversations.find(c => c.conversationId === state.activeConversationId);
                if (local) {
                    local.conversationId = data.conversationId;
                    state.messages[data.conversationId] = state.messages[state.activeConversationId];
                    delete state.messages[state.activeConversationId];
                    state.activeConversationId = data.conversationId;
                    saveState();
                    renderChatList();
                }
            }
        } catch (err) {
            console.error('Send failed', err);
            removeLoadingBubble(loadingToken);
            pushMessage(state.activeConversationId, 'bot', 'I could not reach the server. Please try again.');
            renderMessagesFor(state.activeConversationId);
            toast('Failed to send message');
        }
    }

    function showLoadingBubble(conversationId) {
        const id = 'loading-' + Date.now();
        if (!state.messages[conversationId]) state.messages[conversationId] = [];
        state.messages[conversationId].push({
            role: 'bot',
            text: '<div class="loading-dots"><span></span><span></span><span></span></div>',
            ts: Date.now(),
            __loadingId: id
        });
        renderMessagesFor(conversationId);
        return id;
    }

    function removeLoadingBubble(loadingId) {
        const arr = state.messages[state.activeConversationId] || [];
        const idx = arr.findIndex(m => m.__loadingId === loadingId);
        if (idx !== -1) {
            arr.splice(idx,1);
            saveState();
        }
    }

    /* ========== WELCOME ========== */
    function showWelcome() {
        mainTitle.textContent = 'AI Tutor';
        messagesEl.innerHTML = `
            <div class="welcome-screen">
                <div class="welcome-icon">ðŸŽ“</div>
                <div class="welcome-title">Welcome to AI Tutor</div>
                <div class="welcome-subtitle">Your intelligent programming mentor. Ask questions about Java, algorithms, design patterns, and more. Start a new conversation to begin.</div>
            </div>
        `;
    }

    /* ========== BOOTSTRAP ========== */
    (function bootstrap(){
        if (!state.conversations.length) {
            const seed = generateConversationObj('New Chat');
            state.conversations.push(seed);
            state.messages[seed.conversationId] = [];
            state.activeConversationId = seed.conversationId;
            saveState();
        }
        initUI();
    })();
</script>
</body>
</html>